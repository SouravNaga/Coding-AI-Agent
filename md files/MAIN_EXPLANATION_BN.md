# web/main.js тАФ рж▓рж╛ржЗржирзЗ рж▓рж╛ржЗржирзЗ ржмрж╛ржВрж▓рж╛ ржмрзНржпрж╛ржЦрзНржпрж╛ (рж╕рж╣ржЬржнрж╛ржмрзЗ)

ржПржЗ ржлрж╛ржЗрж▓ржЯрж┐ `web/main.js`тАСржПрж░ ржкрзНрж░рждрж┐ржЯрж┐ ржЧрзБрж░рзБрждрзНржмржкрзБрж░рзНржг рж▓рж╛ржЗржирзЗрж░ рж╕рж╣ржЬ ржмрж╛ржВрж▓рж╛ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржпрж╝, ржпрж╛рждрзЗ ржЖржкржирж┐ рж╕рж╣ржЬрзЗ ржмрзБржЭрждрзЗ ржкрж╛рж░рзЗржи ржкрзНрж░рждрж┐ржЯрж┐ ржХрзЛржб ржХрж┐ ржХрж░рзЗ ржПржмржВ ржХрзЗржи ржЖржЫрзЗред

---

## рж╕ржВржХрзНрж╖рж┐ржкрзНржд рж╕рж╛рж░рж╛ржВрж╢
`web/main.js` ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯтАСрж╕рж╛ржЗржб рж▓ржЬрж┐ржХ тАФ ржЪрзНржпрж╛ржЯ ржЙржЗржирзНржбрзЛ рж░рзЗржирзНржбрж╛рж░ ржХрж░рж╛, ржмрж╛ржЯржирзЗ ржХрзНрж▓рж┐ржХ/ржлрж░рзНржо рж╕рж╛ржмржорж┐рж╢ржи ржХрзНржпрж╛ржкржЪрж╛рж░ ржХрж░рж╛, рж╕рж╛рж░рзНржнрж╛рж░рзЗ POST `/api/chat` ржкрж╛ржарж╛ржирзЛ ржПржмржВ рж╕рж╛рж░рзНржнрж╛рж░ ржерзЗржХрзЗ ржкрзНрж░рж╛ржкрзНржд рж░рж┐ржкрзНрж▓рж╛ржЗ ржЯрж╛ржЗржкрж░рж╛ржЗржЯрж╛рж░ ржЕрзНржпрж╛ржирж┐ржорзЗрж╢ржи ржжрж┐рзЯрзЗ ржжрзЗржЦрж╛ржирзЛред

---

## рж▓рж╛ржЗржирзЗ рж▓рж╛ржЗржирзЗ ржмрзНржпрж╛ржЦрзНржпрж╛
(ржкрзНрж░рждрж┐ржЯрж┐ ржХрзЛржб рж▓рж╛ржЗржирзЗрж░ ржкрж╛рж╢рзЗ ржЫрзЛржЯ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрзЗржУрзЯрж╛ ржЖржЫрзЗ)

1) const chatEl = document.getElementById('chat');
   - `#chat` ржирж╛ржоржХ DOM ржЙржкрж╛ржжрж╛ржиржЯрж┐ ржЦрзЛржБржЬ ржПржмржВ `chatEl` ржП рж╕ржВрж░ржХрзНрж╖ржг; ржПржЦрж╛ржирзЗ ржХржерзЛржкржХржержирзЗрж░ ржЯрж╛рж░рзНржиржЧрзБрж▓рзЛ ржжрзЗржЦрж╛ржирзЛ рж╣ржмрзЗред

2) const inputEl = document.getElementById('input');
   - ржЗржиржкрзБржЯ ржмржХрзНрж╕рзЗрж░ DOM рж░рзЗржлрж╛рж░рзЗржирзНрж╕; ржпрзЗржЦрж╛ржирзЗ ржЗржЙржЬрж╛рж░ ржЯрж╛ржЗржк ржХрж░рзЗред

3) const form = document.getElementById('form');
   - ржЪрзНржпрж╛ржЯ ржлрж░ржо (ржЗржиржкрзБржЯ + рж╕рзЗржирзНржб ржмрзЛрждржи) рж░рзЗржлрж╛рж░рзЗржирзНрж╕; рж╕рж╛ржмржорж┐рж╢ржи ржПржЦрж╛ржирзЗ рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рж╛ рж╣ржмрзЗред

4) // client-side history (no system message here)
   const history = [];
   - `history` ржЕрзНржпрж╛рж░рзЗ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯтАСрж╕рж╛ржЗржбрзЗ ржХржерзЛржкржХржержи ржзрж░рзЗ рж░рж╛ржЦрзЗ (user ржУ assistant turn ржЧрзБрж▓рзЛ)ред

5) function render() { ... }
   - ржПржЗ ржлрж╛ржВрж╢ржи `history` ржерзЗржХрзЗ HTML рждрзИрж░рж┐ ржХрж░рзЗ ржПржмржВ `chatEl.innerHTML`-ржП ржмрж╕рж╛ржпрж╝ред
   - `.replace(/\n/g, '<br>')` ржХрж░рзЗ ржирждрзБржи рж▓рж╛ржЗржирзЗ ржмрзНрж░рзЗржХ ржжрзЗржпрж╝ ржпрж╛рждрзЗ ржХрзЛржб / ржкрж╛ржарзНржп ржарж┐ржХ ржжрзЗржЦрж╛ ржпрж╛ржпрж╝ред
   - рж╢рзЗрж╖рзЗ `chatEl.scrollTop = chatEl.scrollHeight;` ржХрж░рзЗ рж╕рзНржХрзНрж░рж▓ ржирж┐ржЪрзЗ ржЪрж▓рзЗ ржЖрж╕ржмрзЗ ржпрж╛рждрзЗ ржирждрзБржи ржмрж╛рж░рзНрждрж╛ ржжрзЗржЦрж╛ ржпрж╛ржпрж╝ред

6) function escapeHtml(unsafe) { ... }
   - ржЗржЙржЬрж╛рж░ ржмрж╛ ржоржбрзЗрж▓ ржерзЗржХрзЗ ржЖрж╕рж╛ ржЯрзЗржХрзНрж╕ржЯржХрзЗ HTMLтАСржЗржиржЬрзЗржХрж╢ржи ржерзЗржХрзЗ ржирж┐рж░рж╛ржкржж ржХрж░рждрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ (special char ржЧрзБрж▓рзЛ ржПрж╕рзНржХрзЗржк ржХрж░рзЗ)ред

7) async function sendMessage(message) { ... }
   - ржорзВрж▓ ржлрж╛ржВрж╢ржи ржпрж╛ ржЗржЙржЬрж╛рж░рзЗрж░ ржмрж╛рж░рзНрждрж╛ рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржкрж╛ржарж╛ржпрж╝ ржПржмржВ рж░рж┐ржкрзНрж▓рж╛ржЗржХрзЗ ржЯрж╛ржЗржктАСрж░рж╛ржЗржЯрж╛рж░ ржХрж░рзЗ ржжрзЗржЦрж╛ржпрж╝ред
   - ржнрзЗрждрж░рзЗрж░ ржзрж╛ржкржЧрзБрж▓рзЛ рж╕ржВржХрзНрж╖рзЗржкрзЗ:
     - optimistic UI: ржЗржЙржЬрж╛рж░рзЗрж░ ржмрж╛рж░рзНрждрж╛ ржЖржЧрзЗ `history.push({ role: 'user', content: message })` ржпрзЛржЧ ржХрж░рзЗ `render()` ржХрж░рзЗред
     - ржЗржиржкрзБржЯ ржЕржжржХрзНрж╖ ржХрж░рзЗ `inputEl.disabled = true` ржПржмржВ ржмрзЛрждржи ржЕржжржХрзНрж╖ ржХрж░рзЗ тАФ ржпрж╛рждрзЗ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ рж╕рж╛ржмржорж┐рж╢ржи ржирж╛ рж╣ржпрж╝ред
     - `fetch('/api/chat', { method: 'POST', body: JSON.stringify({ history, message }) })` тАФ рж╕рж╛рж░рзНржнрж╛рж░рзЗ POST ржХрж░рзЗред рж╕рж╛рж░рзНржнрж╛рж░ `history` ржУ `message` ржкрзЗржпрж╝рзЗ ржоржбрзЗрж▓ ржХрж▓ ржХрж░рзЗ рж░рж┐ржкрзНрж▓рж╛ржЗ ржжрзЗржпрж╝ред
     - рж╕рж╛рж░рзНржнрж╛рж░ рж╕ржлрж▓ рж╣рж▓рзЗ: `history.push({ role: 'assistant', content: '' }); render();` ржХрж░рзЗ ржкрзНрж▓рзЗрж╕рж╣рзЛрж▓рзНржбрж╛рж░ рж░рж╛ржЦрзЗ ржПржмржВ `typewriterAnimate(reply, onUpdate, 16)` ржжрж┐рзЯрзЗ ржЕржХрзНрж╖рж░ржнрж┐рждрзНрждрж┐ржХ ржЕрзНржпрж╛ржирж┐ржорзЗрж╢ржи ржЪрж╛рж▓рж╛ржпрж╝; ржкрзНрж░рждрж┐ржЯрж┐ ржЖржкржбрзЗржЯрзЗ `history`-рж░ рж╢рзЗрж╖ ржЖржЗржЯрзЗржорзЗрж░ `content` ржмржжрж▓рзЗ `render()` ржХрж░рж╛ рж╣ржпрж╝ред
     - ржПрж░рж░ рж╣рж▓рзЗ рж╕ржорждрзБрж▓рзНржп ржЯрж╛ржЗржктАСрж░рж╛ржЗржЯрж╛рж░ ржХрж░рзЗ рждрзНрж░рзБржЯрж┐ ржмрж╛рж░рзНрждрж╛ ржжрзЗржЦрж╛ржпрж╝ред
     - рж╕рж░рзНржмрж╢рзЗрж╖рзЗ ржЗржиржкрзБржЯ ржЖржмрж╛рж░ рж╕ржХрзНрж░рж┐ржпрж╝ ржХрж░рзЗ ржжрзЗржпрж╝ред

8) // Typewriter animation helper
   function typewriterAnimate(text, onUpdate, delay = 20) { ... }
   - ржПржХржЯрж┐ ржЫрзЛржЯ рж╣рзЗрж▓рзНржкрж╛рж░ ржпрж╛ ржкрзНрж░рждрж┐ `delay` ржорж┐рж▓рж┐рж╕рзЗржХрзЗржирзНржбрзЗ ржПржХржЯрж┐тАСржПржХржЯрж┐ ржЕржХрзНрж╖рж░ ржпрзЛржЧ ржХрж░рзЗ `onUpdate(partialText)` ржХрж▓ ржХрж░рзЗред
   - ржПржЯрж┐ ржПржХржЯрж┐ Promise рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗ ржпрж╛рждрзЗ `await typewriterAnimate(...)` ржХрж░рзЗ ржЖржорж░рж╛ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рждрзЗ ржкрж╛рж░рж┐ ржпржЦржи ржкрж░рзНржпржирзНржд ржкрзБрж░рзЛ ржЯрзЗржХрзНрж╕ржЯ ржжрзЗржЦрж╛ржирзЛ ржирж╛ рж╣ржпрж╝ред

9) form.addEventListener('submit', (e) => { ... });
   - ржлрж░ржо рж╕рж╛ржмржорж┐рж╢ржи рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рзЗ:
     - `e.preventDefault()` ржХрж░рзЗ ржкрзЗржЬ рж░рж┐рж▓рзЛржб ржмржирзНржз ржХрж░рзЗред
     - ржЗржиржкрзБржЯрзЗрж░ ржорж╛ржи ржЙржжрзНржзрж╛рж░ ржХрж░рзЗ ржУ ржЯрзНрж░рж┐ржо ржХрж░рзЗ; ржпржжрж┐ ржЦрж╛рж▓рж┐, ржХрж┐ржЫрзБ ржХрж░рзЗ ржирж╛ред
     - ржпржжрж┐ ржЗржЙржЬрж╛рж░ `good bye|bye|exit` ржЯрж╛ржЗржк ржХрж░рзЗ, рж▓рзЛржХрж╛рж▓рж┐ ржПржХржЯрж┐ `Good Bye!` ржорзЗрж╕рзЗржЬ ржпрзЛржЧ ржХрж░рзЗ ржПржмржВ ржЗржиржкрзБржЯ/ржмрзЛрждржи ржмржирзНржз ржХрж░рзЗ ржжрзЗржпрж╝ (рж▓рзЛржХрж╛рж▓ ржПржХрзНрж╕рж┐ржЯ ржУ ржЗржЙржЬрж╛рж░-ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржмржирзНржз)ред
     - ржЕржирзНржпржерж╛ржпрж╝ `sendMessage(value);` ржЪрж╛рж▓рж╛ржпрж╝ред

10) render();
   - рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рж▓рзЛржб рж╣рж▓рзЗ ржкрзНрж░ржержорзЗ `render()` ржбрж╛ржХрж╛ рж╣ржпрж╝ ржпрж╛рждрзЗ ржХржиржЯрзЗржирзНржЯ рж░рзЗржирзНржбрж╛рж░ рж╣ржпрж╝ (рж╢рзБрж░рзБрждрзЗ ржЦрж╛рж▓рж┐ рж╣ржмрзЗ)ред

---

## ржирзЛржЯ ржУ ржЯрж┐ржкрж╕
- **Context:** ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗ `history` ржЕрзНржпрж╛рж░рзЗржЯрж╛ржЗ contextред ржкрзНрж░рждрж┐ржмрж╛рж░ рж╕рж╛рж░рзНржнрж╛рж░рзЗ `history` ржкрж╛ржарж╛ржирзЛ рж╣рзЯ ржпрж╛рждрзЗ рж╕рж╛рж░рзНржнрж╛рж░ ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ рж░рзЗрж╕ржкржирзНрж╕ рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░рзЗред
- **рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐:** API ржХрзА ржХрзЗржмрж▓ рж╕рж╛рж░рзНржнрж╛рж░тАСрж╕рж╛ржЗржбрзЗ ржерж╛ржХрж╛ ржЙржЪрж┐ржд; ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗ ржХржЦржирзЛ ржкрж╛ржарж╛ржмрзЗржи ржирж╛ред
- **Typewriter speed:** `typewriterAnimate`-ржПрж░ `delay` ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗ ржЖржкржирж┐ рж╕рзНржкрж┐ржб ржмрж╛ржбрж╝рж╛рждрзЗ ржмрж╛ ржХржорж╛рждрзЗ ржкрж╛рж░рзЗржи (ржХрзНрж╖рзБржжрзНрж░ ржорж╛ржи = ржжрзНрж░рзБржд)ред

---

## ржжрзНрж░рзБржд ржмрж╛ржВрж▓рж╛ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк
`web/main.js` ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯтАСрж╕рж╛ржЗржб ржЪрзНржпрж╛ржЯ ржорзНржпрж╛ржирзЗржЬрж╛рж░: UI рж░рзЗржирзНржбрж╛рж░, рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржмрж╛рж░рзНрждрж╛ ржкрж╛ржарж╛ржирзЛ, ржПржмржВ рж╕рж╛рж░рзНржнрж╛рж░ ржерзЗржХрзЗ ржкрзНрж░рж╛ржкрзНржд рж░рж┐ржкрзНрж▓рж╛ржЗ ржЯрж╛ржЗржктАСрж░рж╛ржЗржЯрж╛рж░ ржЕрзНржпрж╛ржирж┐ржорзЗрж╢ржирзЗ ржжрзЗржЦрж╛ржирзЛред

---

ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ ржЖржорж┐:
- ржкрзНрж░рждрж┐ржЯрж┐ рж▓рж╛ржЗржирзЗрж░ ржкрж╛рж╢рзЗ рж╕рж░рж╛рж╕рж░рж┐ `web/main.js`-ржП ржХржорзЗржирзНржЯ рж╣рж┐рж╕рзЗржмрзЗ ржПржЗ ржмрзНржпрж╛ржЦрзНржпрж╛ ржпрзЛржЧ ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐, ржЕржержмрж╛
- `typewriter` ржХржорзНржкрзЛржирзЗржирзНржЯрзЗ ржжрзНрж░рзБрждрждрж╛ ржХржирзНржЯрзНрж░рзЛрж▓ ржпрзЛржЧ ржХрж░рждрзЗ ржкрж╛рж░рж┐ (UI ржП), ржЕржержмрж╛
- рж╕рж╛рж░рзНржнрж╛рж░тАСрж╕рж╛ржЗржб рж╕рзНржЯрзНрж░рж┐ржорж┐ржВ рж╕ржорж░рзНржержи ржпрзЛржЧ ржХрж░рзЗ ржХрзЛржб ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзЗ ржжрж┐рждрзЗ ржкрж╛рж░рж┐ред

ржХрзЛржиржЯрж╛ ржХрж░ржмрзЗржи? ЁЯЪА